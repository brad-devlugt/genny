SchemaVersion: 2018-07-01
Owner: "@mongodb/product-perf"
Description: |
  This workload benchmarks various types of find queries on sharded clusters.
  It measures performance of indexed lookups, shard key based lookups, and unindexed lookups.

GlobalDefaults:
  Nop: &Nop {Nop: true}
  MaxPhases: &MaxPhases 6
  Database: &Database test
  Collection: &Collection Collection0
  Namespace: &Namespace test.Collection0
  Threads: &Threads 32
  NumDocs: &NumDocs 10000000
  Duration: &Duration 5 minutes
  StringGenerator: &StringGenerator {^FastRandomString: {length: 8}}
  TargetedStringGenerator: &TargetedStringGenerator
    ^Join:
      # Default alphabet starts with A, restrict all but the last character to target
      # a very narrow range at the start of the keyspace
      array: ["AAAAAAA", {^FastRandomString: {length: 1} }]

Clients:
  Default:
    QueryOptions:
      maxPoolSize: 500
      socketTimeoutMS: 3600000
  Insert:
    QueryOptions:
      maxPoolSize: 500
      socketTimeoutMS: 3600000
  Query:
    QueryOptions:
      maxPoolSize: 500
      socketTimeoutMS: 3600000
  Remove:
    QueryOptions:
      maxPoolSize: 500
      socketTimeoutMS: 3600000
  Update:
    QueryOptions:
      maxPoolSize: 500
      socketTimeoutMS: 3600000


Actors:
- Name: CreateShardedCollection
  Type: AdminCommand
  Threads: 1
  Phases:
    OnlyActiveInPhases:
      Active: [0]
      NopInPhasesUpTo: *MaxPhases
      PhaseConfig:
        Repeat: 1
        Database: admin
        Operations:
        - OperationMetricsName: EnableSharding
          OperationName: AdminCommand
          OperationCommand:
            enableSharding: *Database
        - OperationMetricsName: ShardCollection
          OperationName: AdminCommand
          OperationCommand:
            shardCollection: *Namespace
            key: {shardKey: 1}

- Name: LoadData
  Type: Loader
  Threads: 1
  Phases:
    OnlyActiveInPhases:
      Active: [1]
      NopInPhasesUpTo: *MaxPhases
      PhaseConfig:
        Repeat: 1
        BatchSize: 10000
        Threads: 1
        DocumentCount: *NumDocs
        Database: *Database
        CollectionCount: 1    # Loader will populate 'Collection0'
        Indexes:
          - keys: {indexed: 1}
        Document:
          unindexed: *StringGenerator
          shardKey: *StringGenerator
          indexed: *StringGenerator

- Name: FindUnindexed
  Type: CrudActor
  Threads: *Threads
  Database: *Database
  Phases:
    OnlyActiveInPhases:
      Active: [2]
      NopInPhasesUpTo: *MaxPhases
      PhaseConfig:
        Name: Unindexed
        Duration: *Duration
        Collection: *Collection
        Operations:
          - OperationName: findOne
            OperationCommand:
              Filter: {unindexed: *StringGenerator}

- Name: FindShardKey_AnyShard
  Type: CrudActor
  Threads: *Threads
  Database: *Database
  Phases:
    OnlyActiveInPhases:
      Active: [3]
      NopInPhasesUpTo: *MaxPhases
      PhaseConfig:
        Name: ShardKey
        Duration: *Duration
        Collection: *Collection
        Operations:
          - OperationName: findOne
            OperationCommand:
              Filter: {shardKey: *StringGenerator}

- Name: FindShardKey_OneShard
  Type: CrudActor
  Threads: *Threads
  Database: *Database
  Phases:
    OnlyActiveInPhases:
      Active: [4]
      NopInPhasesUpTo: *MaxPhases
      PhaseConfig:
        Name: ShardKey
        Duration: *Duration
        Collection: *Collection
        Operations:
          - OperationName: findOne
            OperationCommand:
              Filter: {shardKey: *TargetedStringGenerator}

- Name: FindIndexed
  Type: CrudActor
  Threads: *Threads
  Database: *Database
  Phases:
    OnlyActiveInPhases:
      Active: [5]
      NopInPhasesUpTo: *MaxPhases
      PhaseConfig:
        Name: Indexed
        Duration: *Duration
        Collection: *Collection
        Operations:
          - OperationName: findOne
            OperationCommand:
              Filter: {indexed: *StringGenerator}

# Guard Against timeout for no output.
- Name: LoggingActor
  Type: LoggingActor
  Threads: 1
  Phases:
    OnlyActiveInPhases:
      Active: [0, 1, 2, 3, 4, 5]
      NopInPhasesUpTo: *MaxPhases
      PhaseConfig:
        LogEvery: 10 seconds
        Blocking: None