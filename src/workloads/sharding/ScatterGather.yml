SchemaVersion: 2018-07-01
Owner: "@mongodb/product-perf"
Description: |
  This workload compares performance of queries that use a shard key
  and queries that do not use a shard key on a ~1GiB data set

GlobalDefaults:
  Nop: &Nop {Nop: true}
  MaxPhases: &MaxPhases 3
  Database: &Database test
  Collection: &Collection Collection0
  Namespace: &Namespace test.Collection0
  Threads: &Threads 32
  Duration: &Duration 10 seconds

Clients:
  Default:
    QueryOptions:
      maxPoolSize: 500
  Insert:
    QueryOptions:
      maxPoolSize: 500
  Query:
    QueryOptions:
      maxPoolSize: 500
  Remove:
    QueryOptions:
      maxPoolSize: 500
  Update:
    QueryOptions:
      maxPoolSize: 500


Actors:
- Name: CreateShardedCollection
  Type: AdminCommand
  Threads: 1
  Phases:
    OnlyActiveInPhases:
      Active: [0]
      NopInPhasesUpTo: *MaxPhases
      PhaseConfig:
        Repeat: 1
        Database: admin
        Operations:
        - OperationMetricsName: EnableSharding
          OperationName: AdminCommand
          OperationCommand:
            enableSharding: *Database
        - OperationMetricsName: ShardCollection
          OperationName: AdminCommand
          OperationCommand:
            shardCollection: *Namespace
            key: {shardKey: 1}

- Name: LoadData
  Type: Loader
  Threads: 1
  Phases:
    OnlyActiveInPhases:
      Active: [1]
      NopInPhasesUpTo: *MaxPhases
      PhaseConfig:
        Repeat: 1
        BatchSize: 10000
        Threads: 1
        DocumentCount: &NumDocs 1000
        Database: *Database
        CollectionCount: 1    # Loader will populate 'Collection0'
        Document:
          unindexed: &RandomString {^RandomString: {length: 32}}
          shardKey: *RandomString
          indexed: *RandomString

- Name: FindUnindexed
  Type: CrudActor
  Threads: *Threads
  Database: *Database
  Phases:
    OnlyActiveInPhases:
      Active: [2]
      NopInPhasesUpTo: *MaxPhases
      PhaseConfig:
        Name: Unindexed
        Duration: *Duration
        Collection: *Collection
        Operations:
          - OperationName: find
            OperationCommand:
              Filter: {unindexed: *RandomString}

- Name: FindShardKey_AnyShard
  Type: CrudActor
  Threads: *Threads
  Database: *Database
  Phases:
    OnlyActiveInPhases:
      Active: [3]
      NopInPhasesUpTo: *MaxPhases
      PhaseConfig:
        Name: ShardKey
        Duration: *Duration
        Collection: *Collection
        Operations:
          - OperationName: find
            OperationCommand:
              Filter: {shardKey: *RandomString}

- Name: FindShardKey_OneShard
  Type: CrudActor
  Threads: *Threads
  Database: *Database
  Phases:
    OnlyActiveInPhases:
      Active: [3]
      NopInPhasesUpTo: *MaxPhases
      PhaseConfig:
        Name: ShardKey
        Duration: *Duration
        Collection: *Collection
        Operations:
          - OperationName: find
            OperationCommand:
              Filter: {shardKey: *RandomString}


- Name: FindIndexed
  Type: CrudActor
  Threads: *Threads
  Database: *Database
  Phases:
    OnlyActiveInPhases:
      Active: [4]
      NopInPhasesUpTo: *MaxPhases
      PhaseConfig:
        Name: Indexed
        Duration: *Duration
        Collection: *Collection
        Operations:
          - OperationName: find
            OperationCommand:
              Filter: {indexed: *RandomString}